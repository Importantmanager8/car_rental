{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Notre flotte de véhicules <span class="badge bg-primary">{{ voitures|length }} disponibles</span></h1>
    
    <!-- Filtres de recherche -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3" id="filters-form">
                <div class="col-md-3">
                    <label for="marque-filter" class="form-label">Marque</label>
                    <select class="form-select" id="marque-filter">
                        <option value="">Toutes</option>
                        {% for marque in marques_uniques %}
                        <option>{{ marque }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="prix-filter" class="form-label">Prix max/jour</label>
                    <input type="range" class="form-range" id="prix-filter" min="0" max="{{ prix_max }}" value="{{ prix_max }}">
                    <span id="prixValue">{{ prix_max }}€</span>
                </div>
                <div class="col-md-3">
                    <label for="type-filter" class="form-label">Type</label>
                    <select class="form-select" id="type-filter">
                        <option value="">Tous</option>
                        {% for type in types_uniques %}
                        <option>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" id="reset-filters" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-undo"></i> Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des voitures -->
    <div class="row row-cols-1 row-cols-md-3 g-4" id="voitures-container">
        {% for voiture in voitures %}
        <div class="col voiture-card" 
             data-marque="{{ voiture.marque }}"
             data-prix="{{ voiture.prix }}"
             data-type="{{ voiture.type }}"
             data-disponible="{{ voiture.disponible|lower }}">
            <div class="card h-100 {% if not voiture.disponible %}opacity-50{% endif %}">
                {% if voiture.image_base64 %}
                <img src="data:image/jpeg;base64,{{ voiture.image_base64 }}" 
                     class="card-img-top" 
                     alt="{{ voiture.marque }} {{ voiture.modele }}"
                     style="height: 200px; object-fit: cover;">
                {% else %}
                <img src="{{ url_for('static', filename='images/default-car.jpg') }}" 
                     class="card-img-top" 
                     alt="Image par défaut"
                     style="height: 200px; object-fit: cover;">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ voiture.marque }} {{ voiture.modele }}</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-info">{{ voiture.annee }}</span>
                        <span class="badge bg-secondary">{{ voiture.type }}</span>
                        <span class="badge bg-dark">{{ voiture.transmission }}</span>
                    </div>
                    <p class="card-text">{{ voiture.description }}</p>
                    <div class="options-list mb-3">
                        <h6>Options :</h6>
                        <div class="d-flex flex-wrap gap-1">
                            {% for option in voiture.options %}
                            <span class="badge bg-light text-dark">{{ option }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="h4">{{ voiture.prix }}€</span>
                            <span class="text-muted">/jour</span>
                            {% if not voiture.disponible %}
                            <div class="text-danger mt-1"><small>Indisponible</small></div>
                            {% endif %}
                        </div>
                        {% if current_user.is_authenticated %}
                            <a href="{{ url_for('main.reserver', voiture_id=voiture._id) }}" 
                               class="btn btn-primary {% if not voiture.disponible %}disabled{% endif %}">
                                <i class="fas fa-calendar-check"></i> Réserver
                            </a>
                        {% else %}
                            <button class="btn btn-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#loginModal">
                                <i class="fas fa-lock"></i> Connectez-vous
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-info">
                Aucune voiture disponible pour le moment.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de connexion -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Connexion requise</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Vous devez être connecté pour effectuer une réservation.</p>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('main.register') }}" class="btn btn-outline-primary">Créer un compte</a>
                <a href="{{ url_for('main.login') }}" class="btn btn-primary">Se connecter</a>
            </div>
        </div>
    </div>
</div>

<!-- Script pour le filtrage dynamique -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const marqueFilter = document.getElementById('marque-filter');
    const prixFilter = document.getElementById('prix-filter');
    const prixValue = document.getElementById('prixValue');
    const typeFilter = document.getElementById('type-filter');
    const resetBtn = document.getElementById('reset-filters');
    const voituresContainer = document.getElementById('voitures-container');
    const voitureCards = document.querySelectorAll('.voiture-card');
    
    // Mise à jour de l'affichage du prix
    prixFilter.addEventListener('input', function() {
        prixValue.textContent = this.value + '€';
        filterVoitures();
    });
    
    // Filtrage lors du changement des sélecteurs
    [marqueFilter, typeFilter].forEach(filter => {
        filter.addEventListener('change', filterVoitures);
    });
    
    // Réinitialisation des filtres
    resetBtn.addEventListener('click', function() {
        marqueFilter.value = '';
        typeFilter.value = '';
        prixFilter.value = prixFilter.max;
        prixValue.textContent = prixFilter.max + '€';
        filterVoitures();
    });
    
    // Fonction de filtrage
    function filterVoitures() {
        const selectedMarque = marqueFilter.value.toLowerCase();
        const selectedType = typeFilter.value.toLowerCase();
        const maxPrix = parseInt(prixFilter.value);
        
        voitureCards.forEach(card => {
            const marque = card.dataset.marque.toLowerCase();
            const type = card.dataset.type.toLowerCase();
            const prix = parseInt(card.dataset.prix);
            const disponible = card.dataset.disponible === 'true';
            
            const marqueMatch = !selectedMarque || marque.includes(selectedMarque);
            const typeMatch = !selectedType || type.includes(selectedType);
            const prixMatch = prix <= maxPrix;
            
            if (marqueMatch && typeMatch && prixMatch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
});
</script>

<style>
    .opacity-50 {
        opacity: 0.5;
    }
    .options-list {
        max-height: 100px;
        overflow-y: auto;
    }
    .voiture-card {
        transition: transform 0.3s ease;
    }
    .voiture-card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}